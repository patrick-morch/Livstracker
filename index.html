<!-- /index.html -->
<!doctype html>
<html lang="no" data-theme="auto" data-density="comfortable">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Livstracker</title>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js" defer></script>

  <style>
    :root{--radius:14px;--gap:16px;--font:14px/1.5 system-ui,Inter,Roboto,sans-serif;--bg:#0b0d10;--card:#11151a;--surface:#0f131a;--text:#e7e7e7;--muted:#9aa4af;--border:#1d232c;--accent:#5aa7ff;--ring:0 0 0 2px rgba(90,167,255,.35);--shadow:0 8px 24px rgba(0,0,0,.35)}
    *{box-sizing:border-box}body{margin:0;font:var(--font);background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:20;display:flex;gap:10px;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border);background:rgba(11,13,16,.9);backdrop-filter:blur(8px)}
    h1{font-size:16px;margin:0}.muted{color:var(--muted)}.small{font-size:12px}
    .container{max-width:1200px;margin:0 auto;padding:0 16px}
    main{padding:var(--gap) 0;display:grid;gap:var(--gap);grid-template-columns:repeat(12,minmax(0,1fr))}
    .span-12{grid-column:span 12}@media (max-width:960px){main{grid-template-columns:repeat(6,1fr)}.span-12{grid-column:span 6}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:calc(var(--gap) - 2px);box-shadow:var(--shadow)}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}.list{display:grid;gap:8px}.item{display:flex;gap:10px;align-items:center;border:1px dashed var(--border);border-radius:10px;padding:8px 10px;background:#0f131a}
    .btn{padding:8px 12px;border:1px solid var(--border);background:var(--surface);color:var(--text);border-radius:10px;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:transparent}.btn.ghost{background:transparent}
    .input,.select,textarea{background:var(--surface);border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:10px}
    .input:focus-visible,.select:focus-visible,textarea:focus-visible,.btn:focus-visible{outline:none;box-shadow:var(--ring)}
    .legend{display:grid;gap:8px;margin-top:8px}.streak{display:flex;gap:6px}
    .dot{width:14px;height:14px;border-radius:4px;border:1px solid var(--border);background:#0f131a}
    .dot.ok{background:#1e8e3e66}.dot.mid{background:#eab30866}.dot.bad{background:#ef444466}
    #authHint{position:fixed;left:0;right:0;top:0;z-index:9999;padding:10px 14px;background:#fef3c7;color:#7c2d12;border-bottom:1px solid #f59e0b;display:none}
    .chip{padding:4px 8px;border:1px solid var(--border);border-radius:999px}
    .top-grid{display:grid;grid-template-columns:1fr 1.4fr;gap:var(--gap)}@media (max-width:900px){.top-grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div id="authHint"></div>

  <header>
    <div class="container" style="display:flex;gap:10px;align-items:center">
      <h1>Livstracker</h1>
      <span id="net" class="small muted"></span><span class="muted">·</span>
      <span id="syncStatus" class="small muted">Init…</span><span class="muted">·</span>
      <span id="sdkChip" class="chip small muted">SDK: …</span>
      <div style="flex:1"></div>
      <button id="btnImport" class="btn">Importer</button>
      <button id="btnExport" class="btn ghost">Eksporter</button>
      <button id="btnLogin" class="btn primary">Logg inn</button>
      <button id="btnLogout" class="btn ghost" style="display:none">Logg ut</button>
    </div>
  </header>

  <div class="container">
    <main>
      <section class="span-12 top-grid">
        <div class="card">
          <div class="row" style="justify-content:space-between;align-items:baseline">
            <h2 style="margin:0">Graf</h2>
            <div class="row">
              <label>Periode
                <select id="period" class="select">
                  <option value="14d">14 dager</option><option value="30d">30 dager</option><option value="365d">1 år</option><option value="all">Alt</option>
                </select></label>
              <label>Akse
                <select id="axisMap" class="select"><option value="auto">Auto</option><option value="manual">Manuell</option></select>
              </label>
              <label class="small" style="display:flex;align-items:center;gap:8px;margin-top:20px">
                <input type="checkbox" id="showGoals"/> Mål-linjer
              </label>
            </div>
          </div>
          <canvas id="chart" height="180"></canvas>
          <div id="legend" class="legend"></div>
          <div class="small muted">Kun tallfelt vises i grafen</div>
        </div>

        <div class="card">
          <h2 style="margin:0 0 8px 0">Felt</h2>
          <div class="row" style="margin-bottom:10px">
            <label style="min-width:200px">Navn
              <input id="f_name" class="input" placeholder="f.eks. Trening (min) / Takknemlighet"/></label>
            <label>Type
              <select id="f_type" class="select"><option value="number">Tall</option><option value="boolean">Av/på (checkbox)</option><option value="text">Tekst</option></select></label>
            <label>Mål (valgfritt, kun tall)
              <input id="f_goal" class="input" type="number" step="any" inputmode="decimal" placeholder="f.eks. 30"/></label>
            <label style="margin-top:22px;flex-direction:row;align-items:center;gap:8px">
              <input id="f_include" type="checkbox"/> I fremdrift</label>
            <button id="btnAddField" class="btn">Legg til</button>
          </div>
          <div id="fieldsList" class="list"></div>
        </div>
      </section>

      <section class="card span-12">
        <div class="row" style="justify-content:space-between">
          <h2 style="margin:0">Siste 14 dager</h2>
          <button id="btnToggleHistory" class="btn">Utvid</button>
        </div>
        <div id="streak" class="streak" style="margin:8px 0"></div>
        <div id="miniCards" class="list"></div>
        <div id="history14" class="list" style="margin-top:10px"></div>
      </section>
    </main>
  </div>

  <input id="fileInput" type="file" accept="application/json" style="display:none"/>

  <script>
    /* ===== Firebase config ===== */
    const FIREBASE_CONFIG={apiKey:"AIzaSyA3xjP9w_q_uWx5ia7bJdfqs3_3RmZUVXg",authDomain:"livstracker.firebaseapp.com",projectId:"livstracker",storageBucket:"livstracker.firebasestorage.app",messagingSenderId:"885451038080",appId:"1:885451038080:web:3df131af07a258a5bc7565"};

    /* ===== Helpers ===== */
    const $=id=>document.getElementById(id); const sleep=ms=>new Promise(r=>setTimeout(r,ms));
    const showBar=msg=>{const el=$("authHint");el.textContent=msg;el.style.display="block"}; const hideBar=()=>$("authHint").style.display="none";
    const todayISO=()=>new Date().toISOString().slice(0,10), iso=d=>new Date(d).toISOString().slice(0,10), addDays=(d,n)=>{const x=new Date(d);x.setDate(x.getDate()+n);return x};
    const lastNDates=n=>{const out=[],b=new Date();for(let i=0;i<n;i++)out.push(iso(addDays(b,-i)));return out}; const uid=()=>'id_'+Math.random().toString(36).slice(2,10);

    /* ===== IndexedDB (v3) ===== */
    const DB_NAME='livstracker',DB_VERSION=3;let db;
    function idbOpen(){return new Promise((res,rej)=>{const rq=indexedDB.open(DB_NAME,DB_VERSION);rq.onupgradeneeded=()=>{const d=rq.result;if(!d.objectStoreNames.contains('fields'))d.createObjectStore('fields',{keyPath:'id'});if(!d.objectStoreNames.contains('entries'))d.createObjectStore('entries',{keyPath:'date'});if(!d.objectStoreNames.contains('tombstones'))d.createObjectStore('tombstones',{keyPath:'id'})};rq.onsuccess=()=>{db=rq.result;res()};rq.onerror=()=>rej(rq.error)})}
    const idbGetAll=s=>new Promise((res,rej)=>{const r=db.transaction(s,'readonly').objectStore(s).getAll();r.onsuccess=()=>res(r.result||[]);r.onerror=()=>rej(r.error)}), idbSet=(s,v)=>new Promise((res,rej)=>{const tx=db.transaction(s,'readwrite');tx.objectStore(s).put(v);tx.oncomplete=()=>res();tx.onerror=()=>rej(tx.error)}), idbDelete=(s,k)=>new Promise((res,rej)=>{const tx=db.transaction(s,'readwrite');tx.objectStore(s).delete(k);tx.oncomplete=()=>res();tx.onerror=()=>rej(tx.error)});

    /* ===== App state ===== */
    let state={fields:[],entries:{},uid:null,axisMapMode:'auto',currentDate:todayISO(),historyExpanded:false};
    const getEntry=d=>state.entries[d]||{};
    const isEmptyVal=(v,t)=>t==='boolean'?v===null||v===undefined:t==='number'?v===null||v===''||v===undefined||Number.isNaN(v):t==='text'?v===null||v===''||v===undefined:v==null||v===''; const isEmptyEntry=v=>{if(!v)return true;for(const[fid,val] of Object.entries(v)){const f=state.fields.find(x=>x.id===fid);if(!f)continue;if(!isEmptyVal(val,f.type))return false}return true};

    /* ===== Firebase/Auth ===== */
    let fb={enabled:false,app:null,auth:null,db:null},unsubFields=null,unsubEntries=null,unsubTombs=null,firstSynced=false;

    async function setBestPersistence(auth){
      try{await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);return'LOCAL'}catch{}
      try{await auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);return'SESSION'}catch{}
      await auth.setPersistence(firebase.auth.Auth.Persistence.NONE);return'NONE'
    }

    async function tryInitFirebase(){
      const sdkOk=!!window.firebase; $("sdkChip").textContent="SDK: "+(sdkOk?"ok":"mangler"); if(!sdkOk){showBar("Firebase SDK mangler (nett/AdBlock?)");return}
      fb.app=firebase.apps.length?firebase.app():firebase.initializeApp(FIREBASE_CONFIG);
      fb.auth=firebase.auth(); fb.db=firebase.firestore(); fb.enabled=true; fb.auth.useDeviceLanguage();

      const mode=await setBestPersistence(fb.auth); $("sdkChip").textContent+=" • "+mode;
      try{await fb.db.enablePersistence({synchronizeTabs:true})}catch{}

      // 1) OBSERVER FØRST
      fb.auth.onAuthStateChanged(async user=>{
        if(user){
          hideBar(); state.uid=user.uid; $("syncStatus").textContent='Pålogget'; $("btnLogin").style.display='none'; $("btnLogout").style.display='inline-block';
          if(!firstSynced){firstSynced=true; await startSync(user.uid).catch(e=>showBar("Synk-feil: "+(e?.message||e)))}
        }else{
          state.uid=null; $("syncStatus").textContent='Ikke pålogget'; $("btnLogout").style.display='none'; $("btnLogin").style.display='inline-block';
          if(unsubFields)unsubFields(); if(unsubEntries)unsubEntries(); if(unsubTombs)unsubTombs();
        }
      });

      // 2) FULLFØR REDIRECT (vis feilmelding hvis "tom retur")
      try{
        if(sessionStorage.getItem('lt_redirect')==='1'){
          const res=await fb.auth.getRedirectResult();
          sessionStorage.removeItem('lt_redirect');
          if(!res || !res.user){ showBar("Login returnerte uten bruker. Sjekk 'Authorized domains' for dette domenet og at cookies ikke blokkeres."); }
        }else{
          // safe no-op for andre tilfeller
          await fb.auth.getRedirectResult().catch(e=>{ if((e?.code||'')!=='auth/no-auth-event'){ showBar(`Redirect-feil: ${e.code} ${e.message}`) }});
        }
      }catch(e){
        const code=e?.code||''; if(code!=='auth/no-auth-event') showBar(`Redirect-feil: ${code} ${e?.message||''}`);
      }
    }

    async function signIn(){
      if(!fb.enabled) return showBar('Firebase ikke klar');
      const provider=new firebase.auth.GoogleAuthProvider(); provider.setCustomParameters({prompt:'select_account'});
      sessionStorage.setItem('lt_redirect','1'); // hvorfor: spore retur
      try{ await fb.auth.signInWithRedirect(provider); }catch(e){ showBar(`Login-feil: ${e?.code||''} ${e?.message||''}`); alert(`Login-feil: ${e?.code||''}\n${e?.message||''}`); }
      return false;
    }
    async function signOut(){ try{ await fb.auth.signOut(); }catch{} }

    /* ===== Synk (kort) ===== */
    async function startSync(uid){
      const u=fb.db.collection('users').doc(uid);
      if(unsubFields)unsubFields(); if(unsubEntries)unsubEntries(); if(unsubTombs)unsubTombs();

      unsubFields=u.collection('fields').onSnapshot(async snap=>{const m=new Map();snap.forEach(d=>{const v=d.data();m.set(v.id,v)});state.fields=[...m.values()].sort((a,b)=>a.name.localeCompare(b.name));for(const f of state.fields)await idbSet('fields',f);renderAll()});
      unsubEntries=u.collection('entries').onSnapshot(async snap=>{const all={};snap.forEach(d=>{const v=d.data();all[v.date]=v.values||{}});state.entries=all;for(const [d,vals] of Object.entries(all))await idbSet('entries',{date:d,values:vals,updatedAt:Date.now()});renderAll()});
      // tombstones valgfritt her – enkel synk holder i denne versjonen
    }

    /* ===== UI + graf (samme som før, forkortet) ===== */
    const chartCtx=$('chart').getContext('2d'), legendEl=$('legend'), periodEl=$('period'), axisEl=$('axisMap'), showGoalsEl=$('showGoals');
    let chart;
    function pickAxis(f){if(state.axisMapMode==='manual'&&f.axisHint)return f.axisHint==='left'?'y':'y1';const n=(f.name||'').toLowerCase();if(n.includes('score')||n.includes('%'))return'y';if(n.includes('timer')||n.includes('min')||n.includes('trening'))return'y1';return(typeof f.goal==='number'&&f.goal>10)?'y':'y1'}
    function renderChart(){
      const period=periodEl.value, since=(period==='all'?null:addDays(new Date(),-({ '14d':14,'30d':30,'365d':365 }[period])));
      const dates=Object.keys(state.entries).sort().filter(d=>!since||new Date(d)>=since); const groups={};
      for(const d of dates){ const g=iso(d); groups[g]??={}; const vals=state.entries[d]||{}; state.fields.forEach(f=>{const v=vals[f.id]; if(typeof v==='undefined')return; (groups[g][f.id]??=[]).push(f.type==='number'?Number(v):null); }); }
      const labels=Object.keys(groups).sort(); const matrix={}; for(const g of labels){ matrix[g]={}; state.fields.forEach(f=>{ if(f.type!=='number'){matrix[g][f.id]=null;return} const arr=(groups[g][f.id]||[]).filter(x=>typeof x==='number'); matrix[g][f.id]=arr.length?arr.reduce((a,b)=>a+b,0)/arr.length:null; }); }
      const fields=state.fields.filter(f=>f.type==='number');
      const colors=['#5aa7ff','#7dd3fc','#a78bfa','#f472b6','#fca5a5','#f59e0b','#34d399','#22d3ee','#60a5fa','#93c5fd'];
      const ds=[]; fields.forEach((f,i)=>{ ds.push({label:f.name,data:labels.map(d=>matrix[d][f.id]??null),yAxisID:pickAxis(f),borderColor:colors[i%colors.length],backgroundColor:'transparent',pointRadius:0,tension:.25}); if(showGoalsEl.checked&&typeof f.goal==='number')ds.push({label:f.name+' mål',data:labels.map(()=>f.goal),yAxisID:pickAxis(f),borderColor:colors[i%colors.length],borderDash:[6,6],pointRadius:0,tension:0}); });
      if(chart) chart.destroy(); const cs=getComputedStyle(document.documentElement);
      chart=new Chart(chartCtx,{type:'line',data:{labels,datasets:ds},options:{responsive:true,animation:false,plugins:{legend:{display:true,position:'bottom'}},scales:{y:{position:'left',min:0,max:100,grid:{color:cs.getPropertyValue('--border')}},y1:{position:'right',min:0,max:10,grid:{drawOnChartArea:false}},x:{grid:{color:cs.getPropertyValue('--border')}}}}});
      legendEl.innerHTML=''; fields.forEach(f=>{const row=document.createElement('div');row.className='item';row.innerHTML=`<div style="flex:1"><b>${f.name}</b>${typeof f.goal==='number'?` <span class="small muted">(mål ${f.goal})</span>`:''}</div><button class="btn small">Vis/Skjul</button>`;row.querySelector('button').onclick=()=>{const i=chart.data.datasets.findIndex(d=>d.label===f.name);const gi=chart.data.datasets.findIndex(d=>d.label===f.name+' mål');if(i>=0)chart.toggleDataVisibility(i);if(gi>=0)chart.toggleDataVisibility(gi);chart.update()};legendEl.appendChild(row)})
    }

    const fieldsList=$('fieldsList'); function renderFieldList(){fieldsList.innerHTML=''; state.fields.forEach(f=>{const w=document.createElement('div');w.className='item';w.innerHTML=`<div style="flex:1"><b>${f.name}</b> <span class="muted small">• ${f.type}${typeof f.goal==='number'?` • mål: ${f.goal}`:''}${f.includeInProgress?` • i fremdrift`:''}</span></div>`;fieldsList.appendChild(w)})}
    function renderHistory14(){const dates=lastNDates(14).reverse(), streak=$('streak'), mini=$('miniCards'), list=$('history14'); streak.innerHTML=''; dates.forEach(d=>{let score=0,max=0;state.fields.filter(f=>f.type==='number'&&typeof f.goal==='number'&&f.includeInProgress).forEach(f=>{max++;const v=Number(getEntry(d)[f.id]||0);if(v>=f.goal)score++});const dot=document.createElement('div');dot.className='dot';if(max===0){}else if(score===0)dot.classList.add('bad');else if(score<max)dot.classList.add('mid');else dot.classList.add('ok');dot.title=new Date(d).toLocaleDateString('no-NO')+` – ${score}/${max}`;streak.appendChild(dot)}); mini.innerHTML=''; state.fields.filter(f=>f.type==='number').forEach(f=>{const vs=dates.map(d=>getEntry(d)[f.id]).filter(v=>typeof v==='number');const avg=vs.length?(vs.reduce((a,b)=>a+b,0)/vs.length):null;const el=document.createElement('div');el.className='item';el.innerHTML=`<div style="flex:1"><b>${f.name}</b><div class="muted small">14d snitt</div></div><div>${avg!==null?avg.toFixed(1):'–'}${typeof f.goal==='number'?` <span class="small muted">/ ${f.goal}</span>`:''}</div>`;mini.appendChild(el)}); list.innerHTML=''; const sel=state.historyExpanded?dates.slice().reverse():dates.slice(-3).reverse(); sel.forEach(d=>{const vals=getEntry(d), filled=Object.entries(vals).filter(([_,v])=>v!==null&&v!==''&&v!==undefined); if(!filled.length)return; const w=document.createElement('div');w.className='item';const title=new Date(d).toLocaleDateString('no-NO',{weekday:'short',day:'2-digit',month:'short'});w.innerHTML=`<div style="flex:1"><b>${title}</b><div class="muted small">${filled.map(([id,v])=>{const f=state.fields.find(x=>x.id===id);if(!f)return'';if(f.type==='text')return `<b>${f.name}:</b> ${String(v).slice(0,80)}`;if(f.type==='boolean')return `<b>${f.name}:</b> ${v?'På':'Av'}`;return `<b>${f.name}:</b> ${v}${typeof f.goal==='number'?` / ${f.goal}`:''}`}).join(' • ')}</div></div>`;list.appendChild(w)})}

    function renderAll(){renderFieldList();renderChart();renderHistory14()}

    /* ===== UI bind ===== */
    function bindUI(){
      $('btnExport').onclick=()=>{const blob=new Blob([JSON.stringify({fields:state.fields,entries:state.entries},null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download='livstracker-export.json';a.click();URL.revokeObjectURL(url)};
      $('btnImport').onclick=()=>$('fileInput').click(); $('fileInput').onchange=e=>{const f=e.target.files?.[0];if(!f)return;f.text().then(t=>{const data=JSON.parse(t);state.fields=data.fields||[];state.entries=data.entries||{};renderAll()})};
      $('btnLogin').onclick=signIn; $('btnLogout').onclick=signOut;
      const upd=()=>{const on=navigator.onLine; $('net').textContent=on?'Online':'Offline'; $('net').className='small '+(on?'':'muted')}; upd(); addEventListener('online',upd); addEventListener('offline',upd);
      $('btnAddField').onclick=()=>{const f={id:uid(),name:$('f_name').value.trim()||'Uten navn',type:$('f_type').value,includeInProgress:$('f_include').checked};const g=$('f_goal').value;if(f.type==='number' && g!=='')f.goal=Number(g);state.fields.push(f);$('f_name').value='';$('f_goal').value='';$('f_include').checked=false;renderFieldList()};
      $('btnToggleHistory').onclick=()=>{state.historyExpanded=!state.historyExpanded;renderHistory14()};
      $('sdkChip').title='Hvis login ikke fester: sjekk Authorized domains (localhost/127.0.0.1/LAN/Vercel) og at cookies er på';
    }

    /* ===== Boot ===== */
    window.addEventListener('load', async ()=>{
      await idbOpen(); state.currentDate=todayISO();
      try{ const fs=await idbGetAll('fields'); state.fields=[...new Map(fs.map(f=>[f.id,f])).values()]; const es=await idbGetAll('entries'); state.entries=Object.fromEntries(es.map(x=>[x.date,x.values])); }catch{}
      bindUI(); renderAll();
      try{ await tryInitFirebase(); }catch(e){ showBar('Auth init feilet: '+(e?.message||e)) }
    });
  </script>
</body>
</html>
