<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Livstracker</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js" defer></script>

  <style>
    body{margin:0;font-family:system-ui;background:#0b0d10;color:#e7e7e7}
    header{padding:12px 16px;display:flex;gap:10px;align-items:center;border-bottom:1px solid #222}
    button{padding:8px 12px;border-radius:8px;border:1px solid #333;background:#151922;color:white;cursor:pointer}
    main{padding:16px}
  </style>
</head>

<body>
<header>
  <strong>Livstracker</strong>
  <span id="status">Ikke pålogget</span>
  <div style="flex:1"></div>
  <button id="login">Logg inn</button>
  <button id="logout" style="display:none">Logg ut</button>
</header>

<main>
  <canvas id="chart" height="120"></canvas>
</main>

<script>
/* ================== FIREBASE CONFIG ================== */
const FIREBASE_CONFIG = {
  apiKey: "AIzaSyB69tSMNhYoodHFPcb14350gwtfjvTqU",
  authDomain: "habit-tracker-e0f50.firebaseapp.com",
  projectId: "habit-tracker-e0f50",
  appId: "1:631163589300:web:4d0ceac0a7085d1420bde1"
};

/* ================== FIREBASE INIT ================== */
let app, auth, db;

function waitForFirebase() {
  return new Promise((res, rej) => {
    const start = Date.now();
    (function check() {
      if (window.firebase && firebase.auth && firebase.firestore) return res();
      if (Date.now() - start > 8000) return rej("Firebase SDK timeout");
      setTimeout(check, 50);
    })();
  });
}

async function initFirebase() {
  await waitForFirebase();

  if (!firebase.apps.length) {
    app = firebase.initializeApp(FIREBASE_CONFIG);
  } else {
    app = firebase.app();
  }

  auth = firebase.auth();
  db = firebase.firestore();

  try {
    await db.enablePersistence({ synchronizeTabs: true });
  } catch (_) {}
}

/* ================== AUTH ================== */
async function login() {
  const provider = new firebase.auth.GoogleAuthProvider();
  await auth.signInWithRedirect(provider);
}

function logout() {
  auth.signOut();
}

/* ================== UI ================== */
const statusEl = document.getElementById("status");
const loginBtn = document.getElementById("login");
const logoutBtn = document.getElementById("logout");

loginBtn.onclick = login;
logoutBtn.onclick = logout;

/* ================== CHART (dummy) ================== */
let chart;
function renderChart() {
  const ctx = document.getElementById("chart");
  if (chart) chart.destroy();

  chart = new Chart(ctx, {
    type: "line",
    data: {
      labels: ["Man","Tir","Ons","Tor","Fre"],
      datasets: [{
        label: "Søvnscore",
        data: [75,80,78,85,82],
        borderColor: "#5aa7ff",
        tension: 0.3
      }]
    },
    options: { responsive:true }
  });
}

/* ================== BOOT ================== */
async function boot() {
  await initFirebase();

  auth.onAuthStateChanged(user => {
    if (user) {
      statusEl.textContent = "Pålogget";
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";
      renderChart();
    } else {
      statusEl.textContent = "Ikke pålogget";
      loginBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
    }
  });
}

window.addEventListener("load", boot);
</script>
</body>
</html>
