<!-- /index.html -->
<!doctype html>
<html lang="no" data-theme="auto" data-density="comfortable">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Livstracker</title>

  <!-- Chart.js + Firebase (compat) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js" defer></script>

  <style>
    /* … behold din stil (forkortet for plass) … */
    :root{--bg:#0b0d10;--card:#11151a;--text:#e7e7e7;--muted:#9aa4af;--border:#1d232c;--accent:#5aa7ff}
    *{box-sizing:border-box}body{margin:0;font:14px/1.45 system-ui,Inter,Roboto,sans-serif;background:var(--bg);color:var(--text)}
    header{padding:14px 18px;display:flex;gap:10px;align-items:center;border-bottom:1px solid var(--border);position:sticky;top:0;background:rgba(11,13,16,.9);backdrop-filter:blur(8px)}
    .btn{padding:8px 12px;border:1px solid var(--border);background:#151922;color:var(--text);border-radius:10px;cursor:pointer}
    .btn.ghost{background:transparent}
    .muted{color:var(--muted)} .small{font-size:12px}
  </style>
</head>
<body>
  <header>
    <h1>Livstracker</h1>
    <span id="net" class="small muted"></span>
    <span class="muted">·</span>
    <span id="syncStatus" class="small muted">Ikke pålogget</span>
    <div style="flex:1"></div>
    <button id="btnImport" class="btn">Importer JSON</button>
    <button id="btnExport" class="btn ghost">Eksporter JSON</button>
    <button id="btnLogin" class="btn">Logg inn</button>
    <button id="btnLogout" class="btn ghost" style="display:none">Logg ut</button>
  </header>

  <!-- Din eksisterende MAIN/UI holdes uendret -->
  <main style="padding:18px">
    <!-- … resten av siden … -->
  </main>

  <input id="fileInput" type="file" accept="application/json" style="display:none" />

  <script>
    /* ========= Firebase config ========= */
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyA3xjP9w_q_uWx5ia7bJdfqs3_3RmZUVXg",
      authDomain: "livstracker.firebaseapp.com",
      projectId: "livstracker",
      storageBucket: "livstracker.firebasestorage.app",
      messagingSenderId: "885451038080",
      appId: "1:885451038080:web:3df131af07a258a5bc7565"
    };

    /* ========= Minimal app state (forkortet) ========= */
    let state={uid:null};
    let fb   ={enabled:false, app:null, auth:null, db:null};

    const syncStatus=document.getElementById('syncStatus');
    const netEl=document.getElementById('net');

    /* ========= Robust SDK-wait ========= */
    function sleep(ms){return new Promise(r=>setTimeout(r,ms));}
    async function waitForFirebase(maxTries=120){ // ~6s total
      while(!window.firebase && maxTries--){ await sleep(50); }
      if(!window.firebase) throw new Error("Firebase SDK lastet ikke");
    }

    /* ========= Firebase init + redirect-result ========= */
    async function initFirebase(){
      await waitForFirebase();
      fb.app  = firebase.apps.length ? firebase.app() : firebase.initializeApp(FIREBASE_CONFIG);
      fb.auth = firebase.auth();
      fb.db   = firebase.firestore();
      fb.enabled = true;

      fb.auth.useDeviceLanguage();
      await fb.auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);

      // Viktig: fullfør eventuelt redirect-flow før vi binder UI
      try {
        const rr = await fb.auth.getRedirectResult();
        if (rr && rr.user) {
          // valgfritt: rr.credential?.accessToken
          console.info("Redirect login OK:", rr.user.uid);
        }
      } catch (e) {
        // Why: disse skjer ofte på iOS/Safari uten 3rd-party cookies
        console.warn("Redirect-resultat feilet:", e?.code, e?.message);
      }
    }

    /* ========= Login / Logout ========= */
    async function signIn(){
      if(!fb.enabled){ alert("Firebase ikke konfigurert."); return; }
      const provider = new firebase.auth.GoogleAuthProvider();
      provider.setCustomParameters({ prompt: "select_account" });

      try {
        await fb.auth.signInWithPopup(provider);
      } catch (e) {
        const code = e?.code || "";
        // Fallback til redirect på kjente popup/cookie-feil
        const shouldRedirect =
          code.includes("popup") ||
          code.includes("operation-not-supported") ||
          code.includes("web-storage-unsupported") ||
          code.includes("third-party-cookie") ||
          code.includes("auth/unauthorized-domain");
        if (shouldRedirect) {
          await fb.auth.signInWithRedirect(provider);
          return;
        }
        // Andre feil → vis kort melding
        console.error("Login-feil:", code, e?.message);
        alert(`Kunne ikke logge inn (${code}). Prøv igjen eller bruk redirect.`);
      }
    }
    async function signOut(){
      try { if(fb.enabled) await fb.auth.signOut(); } catch(e){ console.warn(e); }
    }

    /* ========= Bind UI ========= */
    function bindHeader(){
      document.getElementById('btnLogin').onclick=signIn;
      document.getElementById('btnLogout').onclick=signOut;

      const upd=()=>{netEl.textContent=navigator.onLine?'Online':'Offline'; netEl.className='small '+(navigator.onLine?'':'muted');};
      window.addEventListener('online',upd); window.addEventListener('offline',upd); upd();
    }

    /* ========= Auth state UI ========= */
    function hookAuthListener(){
      if(!fb.enabled) return;
      fb.auth.onAuthStateChanged(async (user)=>{
        if(user){
          state.uid=user.uid;
          syncStatus.textContent='Pålogget';
          document.getElementById('btnLogout').style.display='inline-block';
          document.getElementById('btnLogin').style.display='none';
          // her kan du starte Firestore-synk (uendret fra før)
        } else {
          state.uid=null;
          syncStatus.textContent='Ikke pålogget';
          document.getElementById('btnLogout').style.display='none';
          document.getElementById('btnLogin').style.display='inline-block';
          // stopp evt. listeners (uendret fra før)
        }
      });
    }

    /* ========= Boot ========= */
    window.addEventListener('load', async ()=>{
      try {
        bindHeader();
        await initFirebase();
        hookAuthListener();
      } catch (e) {
        console.error(e);
        alert("Klarte ikke starte Firebase. Last siden på nytt.");
      }
      // … kall dine øvrige boot-funksjoner her (render, idb, osv.) …
    });
  </script>
</body>
</html>
