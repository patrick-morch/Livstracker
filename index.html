<!-- index.html -->
<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Livstracker</title>

  <!-- Libs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js" defer></script>

  <style>
    :root{--bg:#0b0d10;--card:#11151a;--text:#e7e7e7;--muted:#9aa4af;--border:#1d232c;--accent:#5aa7ff}
    *{box-sizing:border-box}body{margin:0;font:14px/1.5 system-ui,Inter,Roboto,sans-serif;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:50;display:flex;gap:10px;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border);background:rgba(11,13,16,.9);backdrop-filter:blur(8px)}
    h1{font-size:16px;margin:0}.muted{color:var(--muted)}.small{font-size:12px}
    .btn{padding:8px 12px;border:1px solid var(--border);background:#151922;color:var(--text);border-radius:10px;cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    .btn.primary{background:var(--accent);border-color:transparent;color:#fff}
    .container{max-width:1200px;margin:0 auto;padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    main{display:grid;gap:14px;grid-template-columns:repeat(12,1fr)} .span-12{grid-column:span 12}
    @media (max-width:960px){main{grid-template-columns:repeat(6,1fr)} .span-12{grid-column:span 6}}
    .legend{display:grid;gap:8px;margin-top:8px}
    .item{display:flex;gap:10px;align-items:center;border:1px dashed var(--border);border-radius:10px;padding:8px;background:#0f131a}
    #authHint{position:fixed;left:0;right:0;top:0;z-index:9999;padding:10px 14px;background:#fef3c7;color:#7c2d12;border-bottom:1px solid #f59e0b;display:none}
    .chip{padding:4px 8px;border:1px solid var(--border);border-radius:999px}
  </style>
</head>
<body>
  <div id="authHint"></div>

  <header>
    <h1>Livstracker</h1>
    <span id="net" class="small muted"></span>
    <span class="muted">·</span>
    <span id="syncStatus" class="small muted">Init…</span>
    <span class="muted">·</span>
    <span id="sdkChip" class="chip small muted">SDK: …</span>
    <div style="flex:1"></div>
    <button id="btnImport" class="btn">Importer</button>
    <button id="btnExport" class="btn">Eksporter</button>
    <!-- NB: inline fallback også -->
    <button id="btnLogin" class="btn primary" onclick="window.__signin && window.__signin()">Logg inn</button>
    <button id="btnLogout" class="btn" style="display:none">Logg ut</button>
  </header>

  <div class="container">
    <main>
      <section class="card span-12">
        <div class="row" style="justify-content:space-between;align-items:baseline">
          <h2 style="margin:0">Graf</h2>
          <div class="row">
            <label>Periode
              <select id="period" class="btn">
                <option value="14d">14 dager</option>
                <option value="30d">30 dager</option>
                <option value="365d">1 år</option>
                <option value="all">Alt</option>
              </select>
            </label>
            <label>Akse
              <select id="axisMap" class="btn">
                <option value="auto">Auto</option>
                <option value="manual">Manuell</option>
              </select>
            </label>
            <label class="small" style="display:flex;align-items:center;gap:8px">
              <input type="checkbox" id="showGoals" /> Mål-linjer
            </label>
          </div>
        </div>
        <canvas id="chart" height="160"></canvas>
        <div id="legend" class="legend"></div>
      </section>

      <!-- Feltadmin (kortet ned – funksjonelt) -->
      <section class="card span-12">
        <h2 style="margin:0 0 8px 0">Felt</h2>
        <div class="row">
          <input id="f_name" class="btn" placeholder="Navn (f.eks. Trening (min))" style="min-width:240px" />
          <select id="f_type" class="btn">
            <option value="number">Tall</option>
            <option value="boolean">Av/på (checkbox)</option>
            <option value="text">Tekst</option>
          </select>
          <input id="f_goal" type="number" step="any" inputmode="decimal" class="btn" placeholder="Mål (valgfritt)" style="width:140px" />
          <label class="small" style="display:flex;align-items:center;gap:8px">
            <input id="f_include" type="checkbox" /> I fremdrift
          </label>
          <button id="btnAddField" class="btn primary">Legg til</button>
        </div>
        <div id="fieldsList" class="legend" style="margin-top:10px"></div>
      </section>
    </main>
  </div>

  <input id="fileInput" type="file" accept="application/json" style="display:none" />

  <script>
    // ---------- CONFIG ----------
    const FIREBASE_CONFIG={apiKey:"AIzaSyA3xjP9w_q_uWx5ia7bJdfqs3_3RmZUVXg",authDomain:"livstracker.firebaseapp.com",projectId:"livstracker",storageBucket:"livstracker.firebasestorage.app",messagingSenderId:"885451038080",appId:"1:885451038080:web:3df131af07a258a5bc7565"};

    // ---------- STATE ----------
    let fb={enabled:false,app:null,auth:null,db:null}, unsubFields=null,unsubEntries=null,firstSynced=false;
    let state={fields:[],entries:{},axisMapMode:'auto'};

    // ---------- HELPERS ----------
    const $=id=>document.getElementById(id);
    const showBar=msg=>{const el=$("authHint");el.textContent=msg;el.style.display="block"};
    const hideBar=()=>{$("authHint").style.display="none"};
    const sleep=ms=>new Promise(r=>setTimeout(r,ms));

    // ---------- AUTH (POPUP → REDIRECT) ----------
    async function setBestPersistence(){
      try{await fb.auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);return'LOCAL'}catch{}
      try{await fb.auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);return'SESSION'}catch{}
      await fb.auth.setPersistence(firebase.auth.Auth.Persistence.NONE);return'NONE';
    }

    async function initFirebase(){
      const sdkOk=!!window.firebase; $("sdkChip").textContent="SDK: "+(sdkOk?"ok":"mangler");
      if(!sdkOk){ showBar("Finner ikke Firebase SDK (nett/AdBlock?)."); return; }

      fb.app=firebase.apps.length?firebase.app():firebase.initializeApp(FIREBASE_CONFIG);
      fb.auth=firebase.auth(); fb.db=firebase.firestore(); fb.enabled=true;
      const mode=await setBestPersistence(); $("sdkChip").textContent+=" • "+mode;

      try{ await fb.db.enablePersistence({synchronizeTabs:true}); }catch{}

      // fullfør ev. redirect (viser feil om noe skurrer)
      try{ await fb.auth.getRedirectResult(); }catch(e){ showBar(`Redirect-feil: ${e.code||""} ${e.message||""}`); }

      // auth observer
      fb.auth.onAuthStateChanged(async user=>{
        if(user){
          hideBar();
          $("syncStatus").textContent="Pålogget";
          $("btnLogin").style.display="none"; $("btnLogout").style.display="inline-block";
          $("btnLogin").disabled=false;
          if(!firstSynced){ firstSynced=true; startSync(user.uid).catch(err=>showBar("Synk-feil: "+(err?.message||err))); }
        }else{
          $("syncStatus").textContent="Ikke pålogget";
          $("btnLogout").style.display="none"; $("btnLogin").style.display="inline-block";
          $("btnLogin").disabled=false;
          if(unsubFields)unsubFields(); if(unsubEntries)unsubEntries();
        }
      });
    }

    async function signIn(){
      try{
        $("btnLogin").disabled=true;
        hideBar();
        if(!fb.enabled||!fb.auth){ showBar("Firebase ikke klart ennå."); $("btnLogin").disabled=false; return false; }

        const provider=new firebase.auth.GoogleAuthProvider();
        provider.setCustomParameters({prompt:"select_account"});

        try{
          await fb.auth.signInWithPopup(provider); // raskest når det funker
        }catch(e){
          const code=e?.code||"";
          if(code.includes("popup")||code.includes("operation-not-supported")||code.includes("web-storage-unsupported")){
            await fb.auth.signInWithRedirect(provider); // fallback → navigerer ut
            return false;
          }
          alert(`Login-feil: ${code}\n${e?.message||""}`); // synlig uansett
          showBar(`Login-feil: ${code} ${e?.message||""}`);
          $("btnLogin").disabled=false;
          return false;
        }
      }catch(err){
        alert("Uventet auth-feil: "+(err?.message||err));
        showBar("Uventet auth-feil: "+(err?.message||err));
        $("btnLogin").disabled=false;
      }
      return false;
    }
    window.__signin=signIn; // inline fallback

    async function signOut(){ try{ await fb.auth.signOut(); }catch{} }

    // ---------- SYNC (kort) ----------
    async function startSync(uid){
      const u=fb.db.collection("users").doc(uid);
      unsubFields=u.collection("fields").onSnapshot(s=>{
        const m=new Map(); s.forEach(d=>m.set(d.id,{id:d.id,...d.data()}));
        state.fields=[...m.values()].sort((a,b)=>a.name.localeCompare(b.name));
        renderLegend();
      });
      unsubEntries=u.collection("entries").onSnapshot(s=>{
        const all={}; s.forEach(d=>{const v=d.data(); all[v.date]=v.values||{};});
        state.entries=all; renderChart();
      });
    }

    // ---------- GRAF ----------
    let chart;
    function renderChart(){
      const labels=Object.keys(state.entries).sort();
      const nums=state.fields.filter(f=>f.type==='number');
      const datasets=nums.map((f,i)=>({
        label:f.name,
        data:labels.map(d=>state.entries[d]?.[f.id] ?? null),
        borderColor:["#5aa7ff","#7dd3fc","#a78bfa","#f472b6","#fca5a5","#f59e0b"][i%6],
        backgroundColor:"transparent",
        pointRadius:0,
        tension:.25,
      }));
      if(chart) chart.destroy();
      const ctx=$("chart").getContext("2d");
      chart=new Chart(ctx,{type:"line",data:{labels,datasets},options:{responsive:true,animation:false,plugins:{legend:{display:true,position:"bottom"}}}});
    }
    function renderLegend(){
      const box=$("legend"); box.innerHTML="";
      state.fields.filter(f=>f.type==='number').forEach(f=>{
        const row=document.createElement("div"); row.className="item";
        row.innerHTML=`<div style="flex:1">${f.name}</div><button class="btn">Vis/Skjul</button>`;
        row.querySelector("button").onclick=()=>{ const i=chart.data.datasets.findIndex(d=>d.label===f.name); if(i>=0){ chart.toggleDataVisibility(i); chart.update(); } };
        box.appendChild(row);
      });
    }

    // ---------- FELT (superkort for demo) ----------
    function uid(){return 'id_'+Math.random().toString(36).slice(2,10)}
    $("btnAddField").onclick=async()=>{
      const name=$("f_name").value.trim()||"Uten navn";
      const type=$("f_type").value;
      const goal=$("f_goal").value;
      const include=$("f_include").checked;
      const f={id:uid(),name,type,includeInProgress:include};
      if(type==='number' && goal!=='') f.goal=Number(goal);
      state.fields.push(f); renderLegend();
      $("f_name").value=""; $("f_goal").value=""; $("f_include").checked=false;
      if(fb.enabled && fb.auth?.currentUser){
        await fb.db.collection("users").doc(fb.auth.currentUser.uid).collection("fields").doc(f.id).set({...f,updatedAt:Date.now()},{merge:true});
      }
    };

    // ---------- FILE IO ----------
    $("btnExport").onclick=()=>{const blob=new Blob([JSON.stringify({fields:state.fields,entries:state.entries},null,2)],{type:"application/json"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download="livstracker-export.json";a.click();URL.revokeObjectURL(url)};
    $("btnImport").onclick=()=>$("fileInput").click();
    $("fileInput").onchange=e=>{const f=e.target.files?.[0]; if(!f) return; f.text().then(t=>{const data=JSON.parse(t); state.fields=data.fields||[]; state.entries=data.entries||{}; renderLegend(); renderChart();});};

    // ---------- BIND ----------
    function bind(){
      const upd=()=>{const on=navigator.onLine; $("net").textContent=on?"Online":"Offline"; $("net").className="small "+(on?"":"muted")}; upd(); addEventListener("online",upd); addEventListener("offline",upd);
      $("btnLogin").addEventListener("click",signIn); // JS-binding
      $("btnLogout").onclick=signOut;
      $("syncStatus").textContent="Klar";
    }

    // ---------- BOOT ----------
    window.addEventListener("load", async ()=>{
      bind();
      $("btnLogin").disabled=true; // lås til auth er klar
      try{
        await initFirebase();
      }catch(e){
        showBar("Init-feil: "+(e?.message||e));
      }finally{
        $("btnLogin").disabled=false; // alltid åpne knappen
      }
      renderLegend(); renderChart();
    });
  </script>
</body>
</html>
