<!-- /index.html -->
<!doctype html>
<html lang="no">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Livstracker</title>

  <style>
    :root{
      --bg:#0b0d10; --card:#11151a; --text:#e7e7e7; --muted:#9aa4af; --accent:#5aa7ff;
      --line:#1d232c; --line2:#263040; --chip:#0f131a;
    }
    *{box-sizing:border-box}
    body{margin:0;font:14px/1.45 system-ui,Inter,Roboto,sans-serif;background:var(--bg);color:var(--text)}
    header{
      padding:14px 18px;display:flex;gap:10px;align-items:center;border-bottom:1px solid var(--line);
      position:sticky;top:0;background:rgba(11,13,16,.92);backdrop-filter:blur(8px);z-index:5
    }
    h1{font-size:16px;margin:0}
    .muted{color:var(--muted)}
    .small{font-size:12px}
    .btn{padding:8px 12px;border:1px solid var(--line2);background:#151922;color:var(--text);border-radius:10px;cursor:pointer}
    .btn.ghost{background:transparent}
    .btn.primary{background:var(--accent);border-color:transparent;color:#07111f}
    .select,.input{
      background:var(--chip);border:1px solid var(--line2);color:var(--text);
      padding:8px 10px;border-radius:10px
    }
    main{padding:18px;display:grid;gap:14px;grid-template-columns:repeat(12,1fr)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .grow{flex:1}
    .grid2{display:grid;grid-template-columns:1fr 1.6fr;gap:14px}
    @media (max-width:1100px){ .grid2{grid-template-columns:1fr} }

    #banner{
      display:none;
      padding:10px 12px;
      border-bottom:1px solid #3a2b0a;
      background:#2b1f07;
      color:#ffd08a;
      font-size:13px
    }

    .sectionTitle{font-weight:600;margin:0 0 8px 0}
    .fieldRow{
      display:grid;grid-template-columns:1fr 180px;
      gap:10px;align-items:center;
      padding:10px 0;border-top:1px dashed #1b212a
    }
    .fieldRow:first-child{border-top:none;padding-top:0}
    .meta{font-size:12px;color:var(--muted)}
    .hearts{display:flex;gap:6px;align-items:center}
    .heart{font-size:16px;opacity:.25}
    .heart.on{opacity:1}
    .pill{padding:6px 10px;border-radius:999px;border:1px solid #2a3342;background:transparent}
    .list{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .listItem{
      display:flex;justify-content:space-between;align-items:center;
      padding:10px;border:1px solid #1b212a;border-radius:12px;background:#0f1318
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js" defer></script>
</head>

<body>
  <div id="banner"></div>

  <header>
    <h1>Livstracker</h1>
    <span id="net" class="small muted"></span>
    <span class="muted">·</span>
    <span id="syncStatus" class="small muted">Ikke pålogget</span>
    <div class="grow"></div>
    <button id="btnImport" class="btn">Importer JSON</button>
    <button id="btnExport" class="btn ghost">Eksporter JSON</button>
    <button id="btnLogin" class="btn primary">Logg inn</button>
    <button id="btnLogout" class="btn ghost" style="display:none">Logg ut</button>
  </header>

  <main>
    <section class="card" style="grid-column:span 12">
      <div class="grid2">

        <!-- LEFT: Dag -->
        <div class="card" style="padding:14px">
          <div class="row" style="justify-content:space-between">
            <div class="row">
              <label class="small muted">Dato</label>
              <input id="datePick" class="input" type="date" />
              <button id="prevDay" class="btn ghost" title="Forrige dag">◀</button>
              <button id="nextDay" class="btn ghost" title="Neste dag">▶</button>
            </div>
            <div class="hearts" id="hearts"></div>
          </div>

          <div style="margin-top:10px" class="card">
            <div class="small muted">Dagens oversikt</div>
            <div style="font-size:18px;font-weight:700;margin-top:4px" id="dayProgress">0/0 (0%)</div>
          </div>

          <div class="row" style="margin-top:10px;justify-content:space-between">
            <button id="btnAddField" class="btn">+ Legg til felt</button>
            <div class="small muted">Tall + checkbox</div>
          </div>

          <div id="fieldsToday" style="margin-top:10px"></div>
        </div>

        <!-- RIGHT: Graf -->
        <div class="card" style="padding:14px">
          <div class="row">
            <label>Periode
              <select id="period" class="select">
                <option value="14">14 dager</option>
                <option value="30">30 dager</option>
                <option value="90">90 dager</option>
                <option value="365">1 år</option>
                <option value="all">Alt</option>
              </select>
            </label>
            <label>Akse
              <select id="axisMap" class="select">
                <option value="auto">Auto</option>
                <option value="manual">Manuell</option>
              </select>
            </label>
            <label class="small" style="display:flex;align-items:center;gap:8px">
              <input type="checkbox" id="showGoals" />
              Mål-linjer
            </label>
            <div class="grow"></div>
            <label>Felt
              <select id="fieldSelect" class="select" multiple size="1" style="min-width:240px"></select>
            </label>
          </div>

          <div style="margin-top:10px">
            <canvas id="chart" height="120"></canvas>
            <div class="small muted" style="margin-top:8px">
              Kun tallfelt i grafen · Venstre 0–100 · Høyre 0–12
            </div>
          </div>

          <div class="list" id="fieldList"></div>
        </div>

      </div>
    </section>
  </main>

  <input id="fileInput" type="file" accept="application/json" style="display:none" />

  <script>
    // ========= Firebase config (DIN) =========
    const FIREBASE_CONFIG = {
      apiKey: "AIzaSyA3xjP9w_q_uWx5ia7bJdfqs3_3RmZUVXg",
      authDomain: "livstracker.firebaseapp.com",
      projectId: "livstracker",
      storageBucket: "livstracker.firebasestorage.app",
      messagingSenderId: "885451038080",
      appId: "1:885451038080:web:3df131af07a258a5bc7565"
    };

    // ========= Utils =========
    const banner = (msg) => {
      const el = document.getElementById('banner');
      if(!msg){ el.style.display='none'; el.textContent=''; return; }
      el.textContent = msg;
      el.style.display='block';
    };
    const todayISO = () => new Date().toISOString().slice(0,10);
    const iso = d => new Date(d).toISOString().slice(0,10);
    const addDays = (d,n)=>{ const x=new Date(d); x.setDate(x.getDate()+n); return x; };
    const slug = (s)=>String(s||'felt').toLowerCase().trim().replace(/[^a-z0-9]+/g,'_').replace(/^_+|_+$/g,'').slice(0,40);

    // ========= IndexedDB (FIX: aldri downgrade) =========
    const DB_NAME='livstracker';
    const DB_VERSION=4; // <-- viktig: høyere enn det du har hatt før
    let db;

    function deleteDB(){
      return new Promise((res,rej)=>{
        const rq=indexedDB.deleteDatabase(DB_NAME);
        rq.onsuccess=()=>res();
        rq.onerror=()=>rej(rq.error);
        rq.onblocked=()=>rej(new Error("deleteDatabase blocked"));
      });
    }

    function idbOpen(){
      return new Promise((res,rej)=>{
        const rq=indexedDB.open(DB_NAME, DB_VERSION);

        rq.onupgradeneeded=()=>{
          const d=rq.result;
          if(!d.objectStoreNames.contains('fields')) d.createObjectStore('fields',{keyPath:'id'});
          if(!d.objectStoreNames.contains('entries')) d.createObjectStore('entries',{keyPath:'date'});
          if(!d.objectStoreNames.contains('meta')) d.createObjectStore('meta',{keyPath:'k'});
        };

        rq.onsuccess=()=>{ db=rq.result; res(); };
        rq.onerror=()=>rej(rq.error);
      });
    }

    const idbGetAll = (store)=>new Promise((res,rej)=>{
      const r=db.transaction(store,'readonly').objectStore(store).getAll();
      r.onsuccess=()=>res(r.result||[]);
      r.onerror=()=>rej(r.error);
    });

    const idbSet = (store,val)=>new Promise((res,rej)=>{
      const tx=db.transaction(store,'readwrite');
      tx.objectStore(store).put(val);
      tx.oncomplete=()=>res();
      tx.onerror=()=>rej(tx.error);
    });

    // ========= State =========
    let state = {
      fields: [],
      entries: {},
      uid: null,
      axisMapMode: 'auto',
      selectedFields: [],
      selectedDate: todayISO()
    };

    // ========= Firebase init/auth =========
    let fb = { enabled:false, app:null, auth:null, db:null };

    function waitForFirebase(){
      return new Promise((resolve, reject) => {
        const start = Date.now();
        (function check(){
          if(window.firebase && firebase.auth && firebase.firestore) return resolve();
          if(Date.now() - start > 8000) return reject(new Error("Firebase SDK lastet ikke (timeout)"));
          setTimeout(check, 50);
        })();
      });
    }

    async function tryInitFirebase(){
      if(!FIREBASE_CONFIG?.apiKey) return;

      await waitForFirebase();

      if(!firebase.apps.length) fb.app = firebase.initializeApp(FIREBASE_CONFIG);
      else fb.app = firebase.app();

      fb.auth = firebase.auth();
      fb.db   = firebase.firestore();
      fb.enabled = true;

      // persistence (kan feile i noen miljøer, men da fortsetter vi)
      try{ await fb.db.enablePersistence({ synchronizeTabs:true }); }catch(e){}

      // fullfør redirect
      try{
        const res = await fb.auth.getRedirectResult();
        const wanted = sessionStorage.getItem('lt_login_redirect') === '1';
        if(wanted){
          sessionStorage.removeItem('lt_login_redirect');
          if(!res?.user && !fb.auth.currentUser){
            banner("Login returnerte uten bruker. Sjekk Authorized domains + cookies.");
          } else {
            banner(null);
          }
        }
      } catch(e){
        console.warn("getRedirectResult:", e?.code, e?.message);
      }
    }

    async function signIn(){
      try{
        if(!fb.enabled) return alert("Firebase ikke konfigurert.");
        banner(null);
        sessionStorage.setItem('lt_login_redirect','1');
        try{ await fb.auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL); } catch(e){}
        const provider = new firebase.auth.GoogleAuthProvider();
        await fb.auth.signInWithRedirect(provider);
      } catch(e){
        console.warn("signIn:", e?.code, e?.message);
        alert(`Login-feil: ${e?.code || ''} ${e?.message || e}`);
      }
    }

    async function signOut(){
      try{ if(fb.enabled && fb.auth.currentUser) await fb.auth.signOut(); }
      catch(e){ console.warn("signOut:", e); }
    }

    // ========= Firestore sync =========
    let unsubFields=null, unsubEntries=null, firstUploaded=false;

    async function collectionHasAny(uid){
      const f=await fb.db.collection('users').doc(uid).collection('fields').limit(1).get();
      const e=await fb.db.collection('users').doc(uid).collection('entries').limit(1).get();
      return !f.empty || !e.empty;
    }

    async function uploadAllLocal(uid){
      const batch=fb.db.batch();
      const uref=fb.db.collection('users').doc(uid);

      state.fields.forEach(f=>{
        batch.set(uref.collection('fields').doc(f.id), {...f, updatedAt: Date.now()},{merge:true});
      });

      Object.entries(state.entries).forEach(([date,values])=>{
        batch.set(uref.collection('entries').doc(date), {date, values, updatedAt: Date.now()},{merge:true});
      });

      await batch.commit();
    }

    async function startSync(uid){
      if(!firstUploaded){
        const hasAny = await collectionHasAny(uid);
        if(!hasAny) await uploadAllLocal(uid);
        firstUploaded = true;
      }

      if(unsubFields) unsubFields();
      if(unsubEntries) unsubEntries();

      unsubFields = fb.db.collection('users').doc(uid).collection('fields')
        .onSnapshot(async snap=>{
          const byId=new Map();
          snap.forEach(d=>{ const v=d.data(); if(v?.id) byId.set(v.id, v); });
          state.fields=[...byId.values()].sort((a,b)=>String(a.name).localeCompare(String(b.name)));
          for(const f of state.fields) await idbSet('fields', f);
          renderAll();
        });

      unsubEntries = fb.db.collection('users').doc(uid).collection('entries')
        .onSnapshot(async snap=>{
          const all={};
          snap.forEach(d=>{
            const v=d.data();
            if(v?.date) all[v.date]=v.values||{};
          });
          state.entries = all;
          for(const [date,values] of Object.entries(all)){
            await idbSet('entries',{date, values, updatedAt: Date.now()});
          }
          renderAll();
        });
    }

    async function pushField(f){
      await idbSet('fields', f);
      if(fb.enabled && state.uid){
        await fb.db.collection('users').doc(state.uid).collection('fields').doc(f.id)
          .set({...f, updatedAt: Date.now()},{merge:true});
      }
    }

    async function pushEntry(date, values){
      await idbSet('entries', {date, values, updatedAt: Date.now()});
      if(fb.enabled && state.uid){
        await fb.db.collection('users').doc(state.uid).collection('entries').doc(date)
          .set({date, values, updatedAt: Date.now()},{merge:true});
      }
    }

    // ========= UI refs =========
    const syncStatusEl = document.getElementById('syncStatus');
    const netEl = document.getElementById('net');

    const datePick = document.getElementById('datePick');
    const prevDay = document.getElementById('prevDay');
    const nextDay = document.getElementById('nextDay');
    const fieldsTodayEl = document.getElementById('fieldsToday');
    const dayProgressEl = document.getElementById('dayProgress');
    const heartsEl = document.getElementById('hearts');

    const periodEl = document.getElementById('period');
    const axisEl = document.getElementById('axisMap');
    const showGoalsEl = document.getElementById('showGoals');
    const fieldSelect = document.getElementById('fieldSelect');
    const fieldList = document.getElementById('fieldList');

    const chartCtx = document.getElementById('chart').getContext('2d');
    let chart;

    // ========= Render: hearts/progress =========
    function computeProgress(date){
      const entry = state.entries[date] || {};
      const progressFields = state.fields.filter(f => f.type==='check' && f.includeInProgress !== false);
      const total = progressFields.length;
      const done = progressFields.filter(f => entry[f.id] === true).length;
      const pct = total ? Math.round(done/total*100) : 0;
      return {done,total,pct};
    }

    function renderHearts(date){
      const {pct} = computeProgress(date);
      const levels = [34, 67, 100];
      heartsEl.innerHTML='';
      levels.forEach(t=>{
        const s=document.createElement('span');
        s.className='heart' + (pct>=t ? ' on' : '');
        s.textContent='♥';
        heartsEl.appendChild(s);
      });
    }

    function renderDayProgress(date){
      const {done,total,pct} = computeProgress(date);
      dayProgressEl.textContent = `${done}/${total} (${pct}%)`;
      renderHearts(date);
    }

    // ========= Render: fields today =========
    function renderFieldsToday(){
      const date = state.selectedDate;
      const entry = state.entries[date] || {};
      fieldsTodayEl.innerHTML='';

      if(!state.fields.length){
        const empty=document.createElement('div');
        empty.className='meta';
        empty.textContent='Legg til felter (tall/checkbox) for å starte.';
        fieldsTodayEl.appendChild(empty);
        renderDayProgress(date);
        return;
      }

      state.fields.forEach(f=>{
        const row=document.createElement('div');
        row.className='fieldRow';

        const left=document.createElement('div');
        const title=document.createElement('div');
        title.style.fontWeight='600';
        title.textContent = f.name;

        const meta=document.createElement('div');
        meta.className='meta';
        const goalTxt = (f.type==='number' && typeof f.goal==='number') ? ` · mål ${f.goal}` : '';
        meta.textContent = `${f.type}${goalTxt}`;

        left.appendChild(title);
        left.appendChild(meta);

        const right=document.createElement('div');
        right.style.display='flex';
        right.style.justifyContent='flex-end';

        if(f.type==='check'){
          const cb=document.createElement('input');
          cb.type='checkbox';
          cb.checked = entry[f.id] === true;
          cb.onchange = async ()=>{
            const next = {...(state.entries[date]||{})};
            next[f.id] = cb.checked;
            state.entries[date]=next;
            await pushEntry(date, next);
            renderAll();
          };
          right.appendChild(cb);
        } else {
          const inp=document.createElement('input');
          inp.className='input';
          inp.type='number';
          inp.step='0.1';
          inp.value = (typeof entry[f.id] === 'number' || typeof entry[f.id] === 'string') ? entry[f.id] : proveNumber(entry[f.id]);
          if(inp.value === 'NaN') inp.value = '';
          inp.onchange = async ()=>{
            const v = inp.value==='' ? null : Number(inp.value);
            const next = {...(state.entries[date]||{})};
            if(v===null || Number.isNaN(v)) delete next[f.id];
            else next[f.id]=v;
            state.entries[date]=next;
            await pushEntry(date, next);
            renderAll();
          };
          right.appendChild(inp);
        }

        row.appendChild(left);
        row.appendChild(right);
        fieldsTodayEl.appendChild(row);
      });

      renderDayProgress(date);
    }

    function proveNumber(v){
      const n = Number(v);
      return Number.isFinite(n) ? n : '';
    }

    // ========= Render: field select + list =========
    function renderFieldSelect(){
      fieldSelect.innerHTML='';
      const numeric = state.fields.filter(f=>f.type==='number');

      numeric.forEach(f=>{
        const opt=document.createElement('option');
        opt.value=f.id;
        opt.textContent=f.name;
        fieldSelect.appendChild(opt);
      });

      // default: alle valgt hvis ingen valgt ennå
      if(!state.selectedFields.length){
        state.selectedFields = numeric.map(f=>f.id);
      }

      [...fieldSelect.options].forEach(o=>{
        o.selected = state.selectedFields.includes(o.value);
      });

      fieldSelect.onchange=()=>{
        state.selectedFields=[...fieldSelect.selectedOptions].map(o=>o.value);
        renderChart();
        renderFieldList();
      };
    }

    function renderFieldList(){
      fieldList.innerHTML='';
      const numeric = state.fields.filter(f=>f.type==='number');
      if(!numeric.length) return;

      numeric.forEach(f=>{
        const li=document.createElement('div');
        li.className='listItem';

        const left=document.createElement('div');
        left.innerHTML = `<div style="font-weight:600">${escapeHtml(f.name)}</div><div class="meta">${(typeof f.goal==='number') ? 'mål '+f.goal : 'ingen mål'}</div>`;

        const btn=document.createElement('button');
        btn.className='btn ghost';
        const on = state.selectedFields.includes(f.id);
        btn.textContent = on ? 'Vis/Skjul' : 'Vis/Skjul';
        btn.onclick=()=>{
          const set=new Set(state.selectedFields);
          if(set.has(f.id)) set.delete(f.id); else set.add(f.id);
          state.selectedFields=[...set];
          renderFieldSelect();
          renderChart();
          renderFieldList();
        };

        li.appendChild(left);
        li.appendChild(btn);
        fieldList.appendChild(li);
      });
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
    }

    // ========= Chart =========
    function dateRangeFromPeriod(period){
      if(period==='all') return null;
      const days = Number(period);
      return addDays(new Date(), -days+1);
    }

    function pickAxis(field){
      if(state.axisMapMode==='manual' && field.axisHint){
        return field.axisHint==='left' ? 'y' : 'y1';
      }
      const n=(field.name||'').toLowerCase();
      if(n.includes('score') || n.includes('%')) return 'y';
      if(n.includes('timer') || n.includes('time') || n.includes('min')) return 'y1';
      if(typeof field.goal==='number' && field.goal>12) return 'y';
      return 'y1';
    }

    function buildSeries(labels, selectedNumeric, showGoals){
      const colors=['#5aa7ff','#7dd3fc','#a78bfa','#f472b6','#fca5a5','#f59e0b','#34d399','#4ade80','#22d3ee','#60a5fa','#93c5fd'];
      const datasets=[];
      selectedNumeric.forEach((f,idx)=>{
        const axis = pickAxis(f);
        const data = labels.map(d=>{
          const v = state.entries[d]?.[f.id];
          return (typeof v === 'number') ? v : null;
        });

        datasets.push({
          label:f.name,
          data,
          yAxisID:axis,
          borderColor:colors[idx%colors.length],
          backgroundColor:colors[idx%colors.length]+'33',
          pointRadius:0,
          tension:.25
        });

        if(showGoals && typeof f.goal==='number'){
          datasets.push({
            label:f.name+' mål',
            data: labels.map(()=>f.goal),
            yAxisID:axis,
            borderColor:colors[idx%colors.length],
            borderDash:[6,6],
            pointRadius:0,
            tension:0
          });
        }
      });
      return datasets;
    }

    function renderChart(){
      const since = dateRangeFromPeriod(periodEl.value);
      const allDates = Object.keys(state.entries).sort();
      const labels = allDates.filter(d=>!since || new Date(d) >= since);

      const numericMap = new Map(state.fields.filter(f=>f.type==='number').map(f=>[f.id,f]));
      const selectedNumeric = state.selectedFields.map(id=>numericMap.get(id)).filter(Boolean);

      if(chart) chart.destroy();
      chart = new Chart(chartCtx, {
        type:'line',
        data:{ labels, datasets: buildSeries(labels, selectedNumeric, showGoalsEl.checked) },
        options:{
          responsive:true,
          animation:false,
          interaction:{mode:'nearest', intersect:false},
          plugins:{ legend:{display:true, position:'bottom'} },
          scales:{
            y:{type:'linear',position:'left',min:0,max:100,grid:{color:'#1e2633'},ticks:{color:'#9aa4af'}},
            y1:{type:'linear',position:'right',min:0,max:12,grid:{drawOnChartArea:false},ticks:{color:'#9aa4af'}},
            x:{grid:{color:'#1e2633'},ticks:{color:'#9aa4af'}}
          }
        }
      });
    }

    // ========= Import/Export =========
    function exportJSON(){
      const blob=new Blob([JSON.stringify({fields:state.fields, entries:state.entries},null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url; a.download='livstracker-export.json';
      a.click();
      URL.revokeObjectURL(url);
    }

    async function importJSON(file){
      const text=await file.text();
      const data=JSON.parse(text);

      const byId=new Map(state.fields.map(f=>[f.id,f]));
      (data.fields||[]).forEach(f=>byId.set(f.id,{...f, updatedAt:Date.now()}));
      state.fields=[...byId.values()];

      for(const f of state.fields) await pushField(f);

      for(const [d,vals] of Object.entries(data.entries||{})){
        state.entries[d]=vals||{};
        await pushEntry(d, state.entries[d]);
      }

      renderAll();
      alert("Import fullført");
    }

    // ========= Add field =========
    async function addFieldFlow(){
      const name = prompt("Navn på felt (f.eks. Søvn timer, Trening, Lese):");
      if(!name) return;

      const typeRaw = prompt("Type: skriv 'number' for tall eller 'check' for checkbox:", "number");
      const type = (String(typeRaw||'').toLowerCase().includes('check')) ? 'check' : 'number';

      const id = `${slug(name)}_${Math.random().toString(16).slice(2,7)}`;

      let goal = null;
      let axisHint = null;
      let includeInProgress = true;

      if(type==='number'){
        const g = prompt("Mål (valgfritt). Tom = ingen mål:", "");
        goal = (g==='' || g===null) ? null : Number(g);
        if(!Number.isFinite(goal)) goal=null;

        const ax = prompt("Akse-hint: skriv 'left' (0–100) eller 'right' (0–12). Tom = auto:", "right");
        axisHint = (ax==='left'||ax==='right') ? ax : null;

        includeInProgress = false; // tall teller ikke i “checkbox progress”
      } else {
        includeInProgress = true;
      }

      const field = {
        id, name,
        type,
        goal,
        axisHint,
        includeInProgress,
        updatedAt: Date.now()
      };

      state.fields.push(field);
      await pushField(field);

      // sørg for at tallfelt dukker i graf-valg
      if(type==='number' && !state.selectedFields.includes(id)){
        state.selectedFields.push(id);
      }

      renderAll();
    }

    // ========= Render all =========
    function renderAll(){
      datePick.value = state.selectedDate;
      renderFieldsToday();
      renderFieldSelect();
      renderFieldList();
      renderChart();
    }

    // ========= Bind UI =========
    function bindUI(){
      document.getElementById('btnExport').onclick = exportJSON;
      document.getElementById('btnImport').onclick = ()=>document.getElementById('fileInput').click();
      document.getElementById('fileInput').onchange = (e)=>{ const f=e.target.files?.[0]; if(f) importJSON(f); };

      document.getElementById('btnLogin').onclick = signIn;
      document.getElementById('btnLogout').onclick = signOut;

      document.getElementById('btnAddField').onclick = addFieldFlow;

      periodEl.onchange = renderChart;
      axisEl.onchange = (e)=>{ state.axisMapMode = e.target.value; renderChart(); };
      showGoalsEl.onchange = renderChart;

      datePick.onchange = ()=>{
        state.selectedDate = datePick.value || todayISO();
        renderFieldsToday();
      };
      prevDay.onclick = ()=>{ state.selectedDate = iso(addDays(state.selectedDate,-1)); renderFieldsToday(); };
      nextDay.onclick = ()=>{ state.selectedDate = iso(addDays(state.selectedDate, 1)); renderFieldsToday(); };

      const upd=()=>{
        netEl.textContent = navigator.onLine ? 'Online' : 'Offline';
      };
      window.addEventListener('online', upd);
      window.addEventListener('offline', upd);
      upd();
    }

    // ========= Boot =========
    async function boot(){
      try{
        await idbOpen();
      } catch(e){
        // Hvis du fortsatt har en “rare” DB i nettleser: auto-fix
        if(e?.name === 'VersionError'){
          banner("Lokal database var i feil versjon. Nullstiller lokal DB…");
          await deleteDB();
          await idbOpen();
          banner(null);
        } else {
          banner(`Boot-feil: ${e?.message || e}`);
          throw e;
        }
      }

      // last lokal data
      const fieldsArr = await idbGetAll('fields');
      const byId=new Map(fieldsArr.map(f=>[f.id,f]));
      state.fields=[...byId.values()];

      const entriesArr = await idbGetAll('entries');
      state.entries = Object.fromEntries(entriesArr.map(x=>[x.date, x.values||{}]));

      // init
      state.selectedDate = todayISO();
      bindUI();
      await tryInitFirebase();

      // auth state
      if(fb.enabled){
        fb.auth.onAuthStateChanged(async (user)=>{
          if(user){
            state.uid=user.uid;
            syncStatusEl.textContent='Pålogget';
            document.getElementById('btnLogout').style.display='inline-block';
            document.getElementById('btnLogin').style.display='none';
            banner(null);
            await startSync(user.uid);
          } else {
            state.uid=null;
            syncStatusEl.textContent='Ikke pålogget';
            document.getElementById('btnLogout').style.display='none';
            document.getElementById('btnLogin').style.display='inline-block';
            if(unsubFields)unsubFields();
            if(unsubEntries)unsubEntries();
          }
        });
      } else {
        syncStatusEl.textContent='Kun lokal lagring';
      }

      renderAll();
    }

    // ========= Start =========
    window.addEventListener('load', ()=>boot());

    /*
      Firestore Rules (publiser disse i Firebase -> Firestore rules)

      rules_version = '2';
      service cloud.firestore {
        match /databases/{db}/documents {
          match /users/{uid}/{col}/{doc} {
            allow read, write: if request.auth != null && request.auth.uid == uid;
          }
        }
      }
    */
  </script>
</body>
</html>
